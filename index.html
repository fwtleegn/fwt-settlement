<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FWT Settlement Assistant</title>

<!--
FWT_INTERNAL_TOOL
Owner: FRIENDS WITH TENNIS
Purpose: Tennis Settlement Assistant
Distribution: Private / Internal Use Only
-->

<script src="https://unpkg.com/tesseract.js@5.0.5/dist/tesseract.min.js"></script>

<style>
:root{--bg:#f5f7f8;--card:#fff;--line:#e6e8eb;--text:#111;--muted:#666;--accent:#0f766e}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;background:var(--bg);color:var(--text)}
.wrap{max-width:920px;margin:18px auto;padding:0 14px 40px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:14px}
h2{font-size:15px;margin:0 0 10px}
label{font-size:12px;color:var(--muted)}
input,textarea,select{width:100%;box-sizing:border-box;padding:10px;border-radius:10px;border:1px solid var(--line);font-size:14px}
textarea{min-height:140px}
button{background:var(--accent);color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
button.secondary{background:#fff;color:#111;border:1px solid var(--line)}
button:disabled{opacity:.55;cursor:not-allowed}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.hr{height:1px;background:var(--line);margin:12px 0}
.big{font-size:18px;font-weight:800}
.mono{font-family:ui-monospace,monospace}
.muted{font-size:12px;color:var(--muted)}
.split{display:flex;justify-content:space-between;align-items:baseline}
.btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}

/* FWT HEADER */
.fwt-header{display:flex;align-items:center;gap:14px;background:var(--accent);color:#fff;padding:14px 18px;border-radius:14px;margin-bottom:16px}
.fwt-logo{font-size:26px;font-weight:900;background:#fff;color:var(--accent);padding:6px 12px;border-radius:10px;letter-spacing:2px}
.fwt-title .name{font-size:16px;font-weight:800}
.fwt-title .sub{font-size:12px;opacity:.85}

/* FOOTER */
.fwt-footer{margin-top:20px;padding:14px;font-size:12px;color:#555;text-align:center;background:#f0fdfa;border:1px solid #c7f0ea;border-radius:12px}

/* preview */
.preview-img{max-width:100%;border-radius:12px;border:1px solid var(--line);display:none;margin-top:10px}
.progressline{margin-top:8px}
</style>
</head>

<body>
<div class="wrap">

<header class="fwt-header">
  <div class="fwt-logo">FWT</div>
  <div class="fwt-title">
    <div class="name">FRIENDS WITH TENNIS</div>
    <div class="sub">Settlement Assistant Â· Internal Use Only</div>
  </div>
</header>

<div class="card">
  <h2>ğŸ“· ì°¸ì„ì ìŠ¤í¬ë¦°ìƒ· OCR (ì—¬ëŸ¬ ì¥ í•œ ë²ˆì—)</h2>
  <div class="muted">íŒ: ëª…ë‹¨ ë¶€ë¶„ë§Œ í¬ê²Œ í™•ëŒ€í•´ì„œ 2~3ì¥ìœ¼ë¡œ ë‚˜ëˆ  ì°ìœ¼ë©´ ì •í™•ë„ ê¸‰ìƒìŠ¹</div>

  <!-- âœ… multiple ì¶”ê°€ -->
  <input type="file" id="imgInput" accept="image/*" multiple>

  <div class="row" style="margin-top:10px">
    <div>
      <label>ì „ì²˜ë¦¬ ê°•ë„(ê¶Œì¥ 2)</label>
      <select id="prepLevel">
        <option value="1">1 (ì•½)</option>
        <option value="2" selected>2 (ê¶Œì¥)</option>
        <option value="3">3 (ê°•)</option>
      </select>
    </div>
    <div>
      <label>í™•ëŒ€ ë°°ìœ¨(ê¶Œì¥ 3x)</label>
      <select id="scale">
        <option value="2">2x</option>
        <option value="3" selected>3x</option>
        <option value="4">4x</option>
      </select>
    </div>
  </div>

  <div class="btns">
    <button id="btnOCR">OCR ì‹¤í–‰(ì„ íƒí•œ ì´ë¯¸ì§€ ì „ë¶€)</button>
    <button class="secondary" id="btnClear">ì´ˆê¸°í™”</button>
  </div>

  <img id="previewImg" class="preview-img" alt="preview">
  <div class="progressline mono muted" id="batchStatus">-</div>
  <div class="hr"></div>
  <div class="mono muted" id="ocrStatus">ëŒ€ê¸°ì¤‘</div>
</div>

<div class="card">
  <h2>ğŸ‘¥ ì°¸ì„ì ëª…ë‹¨</h2>
  <div class="muted">#ìœ¼ë¡œ ì‹œì‘í•˜ë©´ ì •ì‚° ì œì™¸ (ì˜ˆ: #ìš´ì˜ì§„)</div>
  <textarea id="names" placeholder="@Olive&#10;@ëƒ¥ì´&#10;ë¸Œë¼ë”&#10;#ìš´ì˜ì§„"></textarea>
  <div class="hr"></div>
  <div class="split">
    <div class="muted">ì •ì‚° ëŒ€ìƒ</div><div class="big mono" id="count">0ëª…</div>
  </div>
</div>

<div class="card">
  <h2>ğŸ’° ë¹„ìš© ì…ë ¥</h2>

  <label>ì½”íŠ¸ë¹„</label>
  <div class="row3">
    <input id="courts" placeholder="ì½”íŠ¸ ìˆ˜ (ì˜ˆ: 2)" inputmode="numeric">
    <input id="hourly" placeholder="ì‹œê°„ë‹¹ ë¹„ìš© (ì˜ˆ: 50000)" inputmode="numeric">
    <input id="hours" placeholder="ì‚¬ìš© ì‹œê°„ (ì˜ˆ: 2)" inputmode="decimal">
  </div>

  <label style="margin-top:10px">ìº”ë³¼</label>
  <div class="row">
    <input id="ballsQty" placeholder="ìº”ë³¼ ìˆ˜ëŸ‰ (ì˜ˆ: 3)" inputmode="numeric">
    <input id="ballsPrice" placeholder="ìº”ë³¼ ê°€ê²© (ì˜ˆ: 10000)" inputmode="numeric">
  </div>

  <div class="hr"></div>

  <div class="split">
    <div class="muted">ì´ ì½”íŠ¸ë¹„</div><div class="big mono" id="courtTotal">0ì›</div>
  </div>
  <div class="split">
    <div class="muted">ì´ ìº”ë³¼ë¹„</div><div class="big mono" id="ballTotal">0ì›</div>
  </div>
  <div class="split">
    <div class="muted">ì´ì•¡</div><div class="big mono" id="grandTotal">0ì›</div>
  </div>
  <div class="split">
    <div class="muted">1/N</div><div class="big mono" id="per">0ì›</div>
  </div>
  <div class="muted mono" id="formula">-</div>
</div>

<div class="card">
  <h2>ğŸ“‹ ë³µì‚¬ìš© ê²°ê³¼ (ëª…ë‹¨ + ì •ì‚°ìš”ì•½)</h2>
  <textarea id="output" class="mono" readonly></textarea>
  <button style="margin-top:8px" id="copyBtn">ë³µì‚¬</button>
</div>

<footer class="fwt-footer">
Â© FRIENDS WITH TENNIS (FWT)<br>
ë³¸ ì›¹ì•±ì€ FWT ë‚´ë¶€ ì •ì‚° ë³´ì¡°ìš©ìœ¼ë¡œë§Œ ì œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
ë¬´ë‹¨ ë³µì œÂ·ë°°í¬Â·ìˆ˜ì • ë° íƒ€ í´ëŸ½ ì‚¬ìš©ì„ ê¸ˆí•©ë‹ˆë‹¤.
</footer>

</div>

<script>
const __FWT_SIGNATURE__ = "FRIENDS_WITH_TENNIS_INTERNAL_ONLY_2026";

const $ = (id) => document.getElementById(id);
const fmt = (n) => Math.round(n).toLocaleString() + "ì›";
const num = (v) => Number(String(v||"").replace(/[,\sì›]/g,"")) || 0;

let isRunning = false;

function getIncludedNames(){
  return $("names").value
    .split("\n")
    .map(v => v.trim())
    .filter(v => v && !v.startsWith("#"));
}

function recalc(){
  const courts = num($("courts").value);
  const hourly = num($("hourly").value);
  const hours  = num($("hours").value);
  const ballsQ = num($("ballsQty").value);
  const ballsP = num($("ballsPrice").value);

  const courtTotal = courts * hourly * hours;
  const ballTotal  = ballsQ * ballsP;
  const grandTotal = courtTotal + ballTotal;

  $("courtTotal").textContent = fmt(courtTotal);
  $("ballTotal").textContent  = fmt(ballTotal);
  $("grandTotal").textContent = fmt(grandTotal);

  const list = getIncludedNames();
  $("count").textContent = list.length + "ëª…";
  $("per").textContent = list.length ? fmt(grandTotal / list.length) : "0ì›";

  $("formula").textContent =
    `${courts}ì½”íŠ¸ Ã— ${hourly.toLocaleString()}ì›/ì‹œê°„ Ã— ${hours}ì‹œê°„ + ` +
    `${ballsQ}ê°œ Ã— ${ballsP.toLocaleString()}ì›`;

  const nameLines = list.map(n => n.startsWith("@") ? n : "@"+n);

  $("output").value = [
    "FRIENDS WITH TENNIS (FWT)",
    "Â© FWT Internal Use Only",
    "",
    "ì´ ì½”íŠ¸ë¹„: " + fmt(courtTotal),
    "ì´ ìº”ë³¼ë¹„: " + fmt(ballTotal),
    "ì´ì•¡: " + fmt(grandTotal),
    "ì •ì‚°ëŒ€ìƒ: " + list.length + "ëª…",
    "1/N: " + (list.length ? fmt(grandTotal / list.length) : "0ì›"),
    "",
    ...nameLines
  ].join("\n");
}

async function preprocessToDataURL(file){
  const level = Number($("prepLevel").value || 2);
  const scale = Number($("scale").value || 3);

  const img = await new Promise((resolve, reject) => {
    const i = new Image();
    i.onload = () => resolve(i);
    i.onerror = reject;
    i.src = URL.createObjectURL(file);
  });

  const canvas = document.createElement("canvas");
  canvas.width  = Math.floor(img.width * scale);
  canvas.height = Math.floor(img.height * scale);
  const ctx = canvas.getContext("2d", { willReadFrequently:true });

  ctx.imageSmoothingEnabled = true;
  ctx.imageSmoothingQuality = "high";
  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

  const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
  const d = imgData.data;

  const contrast = level === 1 ? 1.2 : level === 2 ? 1.6 : 2.0;
  const thresh   = level === 1 ? 170 : level === 2 ? 155 : 140;

  for(let i=0;i<d.length;i+=4){
    const r=d[i], g=d[i+1], b=d[i+2];
    let y = 0.299*r + 0.587*g + 0.114*b;
    y = (y - 128) * contrast + 128;
    const v = (y > thresh) ? 255 : 0;
    d[i]=d[i+1]=d[i+2]=v;
    d[i+3]=255;
  }
  ctx.putImageData(imgData,0,0);

  const dataUrl = canvas.toDataURL("image/png");
  URL.revokeObjectURL(img.src);
  return dataUrl;
}

function cleanOCRText(text){
  const lines = (text||"")
    .split(/\r?\n/)
    .map(l => l.replace(/[â€¢Â·]/g," ").replace(/\s+/g," ").trim())
    .filter(l => l.length >= 2);

  const filtered = lines.filter(l => !/^\d+$/.test(l));
  return filtered.join("\n");
}

// âœ… ì—¬ëŸ¬ ì¥ OCR: í•œ ì¥ì”© ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬
async function runBatchOCR(){
  if (isRunning) return;

  const files = Array.from($("imgInput").files || []);
  if (!files.length){
    $("ocrStatus").textContent = "ì´ë¯¸ì§€ ì„ íƒ í•„ìš”";
    return;
  }

  isRunning = true;
  $("btnOCR").disabled = true;
  $("imgInput").disabled = true;
  $("batchStatus").textContent = `ì„ íƒ ì´ë¯¸ì§€: ${files.length}ì¥`;

  try{
    // Worker 1ë²ˆë§Œ ë§Œë“¤ê³  ì—¬ëŸ¬ ì¥ì— ì¬ì‚¬ìš©(ì†ë„/ì•ˆì •ì„±)
    $("ocrStatus").textContent = "OCR ì›Œì»¤ ì¤€ë¹„ì¤‘â€¦";
    const worker = await Tesseract.createWorker("kor+eng", 1, {
      logger: (m) => {
        const p = m.progress ? ` ${(m.progress*100).toFixed(0)}%` : "";
        $("ocrStatus").textContent = `${m.status}${p}`;
      },
      workerPath: "https://unpkg.com/tesseract.js@5.0.5/dist/worker.min.js",
      corePath: "https://unpkg.com/tesseract.js-core@5.0.0/tesseract-core.wasm.js",
      langPath: "https://tessdata.projectnaptha.com/4.0.0"
    });

    await worker.setParameters({
      tessedit_pageseg_mode: "6",
      preserve_interword_spaces: "1"
    });

    let appendedAny = false;

    for (let i=0; i<files.length; i++){
      const f = files[i];
      $("batchStatus").textContent = `ì²˜ë¦¬ì¤‘: ${i+1}/${files.length} (${f.name})`;

      $("ocrStatus").textContent = "ì „ì²˜ë¦¬ ì¤‘â€¦";
      const dataUrl = await preprocessToDataURL(f);

      // ë¯¸ë¦¬ë³´ê¸°ëŠ” í˜„ì¬ ì²˜ë¦¬ì¤‘ì¸ ì´ë¯¸ì§€ë¡œ ê°±ì‹ 
      $("previewImg").src = dataUrl;
      $("previewImg").style.display = "block";

      const { data } = await worker.recognize(dataUrl);
      const cleaned = cleanOCRText(data?.text || "");

      if (cleaned.trim()){
        const prev = $("names").value.trim();
        $("names").value = prev ? (prev + "\n" + cleaned) : cleaned;
        appendedAny = true;
        recalc();
      }
    }

    await worker.terminate();

    if (!appendedAny){
      $("ocrStatus").textContent = "OCR ê²°ê³¼ê°€ ë¹„ì—ˆìŒ (ì´ë¯¸ì§€ í™•ëŒ€/ìë¥´ê¸°/ë¼ì´íŠ¸ëª¨ë“œ ê¶Œì¥)";
    } else {
      $("ocrStatus").textContent = "ë°°ì¹˜ OCR ì™„ë£Œ (ì˜¤íƒˆì/ëˆ„ë½ 1íšŒ ê²€í†  ê¶Œì¥)";
    }
    $("batchStatus").textContent = `ì™„ë£Œ: ${files.length}ì¥ ì²˜ë¦¬`;
  } catch(e){
    $("ocrStatus").textContent = "OCR ì‹¤íŒ¨: https í™˜ê²½/ë„¤íŠ¸ì›Œí¬/ì´ë¯¸ì§€ í’ˆì§ˆ í™•ì¸ í•„ìš”";
    $("batchStatus").textContent = "ì‹¤íŒ¨";
  } finally {
    isRunning = false;
    $("btnOCR").disabled = false;
    $("imgInput").disabled = false;
  }
}

$("btnOCR").onclick = runBatchOCR;

$("btnClear").onclick = () => {
  $("names").value="";
  $("output").value="";
  $("imgInput").value="";
  $("previewImg").style.display="none";
  $("ocrStatus").textContent="ëŒ€ê¸°ì¤‘";
  $("batchStatus").textContent="-";
  recalc();
};

$("copyBtn").onclick = async () => {
  try{
    await navigator.clipboard.writeText($("output").value);
    alert("ë³µì‚¬ ì™„ë£Œ");
  }catch(e){
    alert("ë³µì‚¬ ì‹¤íŒ¨(ë¸Œë¼ìš°ì € ê¶Œí•œ). í…ìŠ¤íŠ¸ë¥¼ ê¸¸ê²Œ ëˆŒëŸ¬ ì§ì ‘ ë³µì‚¬í•´ì¤˜.");
  }
};

["courts","hourly","hours","ballsQty","ballsPrice","names"].forEach(id=>{
  $(id).addEventListener("input", recalc);
});

recalc();
</script>
</body>
</html>
